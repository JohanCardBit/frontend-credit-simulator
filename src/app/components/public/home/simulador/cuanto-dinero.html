<div class="mainn">

  @if (!mostrarResultados && !mostrarWelcome && !mostrarPlanPagos) {
  <section class="container-simulador" [formGroup]="form">
    <div class="btn-prev-exit d-flex justify-content-between">

      @if(inLogin == false) {
      <div routerLink="/home" class="prev">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <title>Atrás</title>
          <path d="M19 12H5" />
          <path d="M11 18l-6-6 6-6" />
        </svg>
        Atrás
      </div>

      <div routerLink="/home" class="exit">Salir
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" role="img" aria-label="Salir"
          fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <title>Salir</title>
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
          <path d="M16 17l5-5-5-5" />
          <path d="M21 12H9" />
        </svg>
      </div>

      }
    </div>



    <div class="simulador-container">
      <h1>¿Cuánto dinero necesitas?</h1>

      <!-- Monto -->
      <div class="monto-input-wrapper">
        <span class="currency">$</span>

        <input type="number" class="monto-input" placeholder="0" formControlName="amount" min="1000000"
          max="500000000" />
      </div>

      <p class="monto-info">
        Monto Mínimo: 1.000.000 - Monto Máximo: 500.000.000
      </p>

      <!-- Errores de monto -->
      @if (form.get('amount')?.touched && form.get('amount')?.invalid) {
      <div class="error">
        @if (form.get('amount')?.errors?.['required']) {
        <span>El monto es obligatorio.</span>
        }
        @else {
        @if (form.get('amount')?.errors?.['min']) {
        <span>Monto mínimo permitido: 1.000.000</span>
        }
        @if (form.get('amount')?.errors?.['max']) {
        <span>Monto máximo permitido: 500.000.000</span>
        }
        }
      </div>
      }

      <!-- Form -->
      <div class="formm">

        <!-- Meses -->
        <div class="form-item">
          <label>¿A cuántos meses?</label>

          <input type="number" formControlName="termMonths" min="48" max="84" placeholder="48" />

          <small>Elige un plazo desde 48 hasta 84 meses</small>

          @if (form.get('termMonths')?.touched && form.get('termMonths')?.invalid) {
          <div class="error">
            @if (form.get('termMonths')?.errors?.['min']) {
            <span>Mínimo 48 meses</span>
            }
            @else if (form.get('termMonths')?.errors?.['max']) {
            <span>Máximo 84 meses</span>
            }
          </div>
          }
        </div>

        <!-- Fecha nacimiento -->
        <div class="form-item">
          <label for="fecha-nacimiento">Fecha de nacimiento</label>

          <input type="date" id="fecha-nacimiento" formControlName="birthDate" />

          <small>Debes tener entre 18 y 84 años para solicitar el crédito.</small>

          @if (form.get('birthDate')?.touched && form.get('birthDate')?.invalid) {
          <div class="error">
            @if (form.get('birthDate')?.errors?.['required']) {
            <span>La fecha es obligatoria.</span>
            }
            @else if (form.get('birthDate')?.errors?.['underAge']) {
            <span>Debes ser mayor de 18 años.</span>
            }
          </div>
          }
        </div>

      </div>

      <!-- Botón -->
      <button class="btn-simular" (click)="simular()" (click)="checkTokenInCookies()">
        SIMULAR
      </button>
    </div>


  </section>
  }

  @if (mostrarResultados && !mostrarWelcome && !mostrarPlanPagos) {
  <div class="btn-prev-exit d-flex justify-content-between ">
    <div (click)="volverAlSimulador()" class="prev">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <title>Atrás</title>
        <path d="M19 12H5" />
        <path d="M11 18l-6-6 6-6" />
      </svg>
      Atrás
    </div>

    @if(inLogin == false) {
    <div routerLink="/home" class="exit">Salir
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" role="img" aria-label="Salir"
        fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <title>Salir</title>
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
        <path d="M16 17l5-5-5-5" />
        <path d="M21 12H9" />
      </svg>
    </div>
    }

  </div>
  <section class="container-opciones">




    <h5 class="text-center fw-bolder">Te ofrecemos estas opciones de Crédito</h5>
    <div class="tarjetas-credito">

      <!-- TARJETA 1 -->
      <div class="tarjeta-credito">
        <div class="encabezado-tarjeta">
          <span class="titulo-tarjeta">Tasa fija - Cuota fija</span>
        </div>

        <div class="monto-credito">
          <p class="label">Por un crédito de:</p>
          <p class="valor"> ${{ resultados?.fija?.requested?.amount ?? 0 | number:'1.0-0' }} </p>
        </div>

        <div class="resumen-cuota">
          <p>Pagarás {{ resultados?.fija?.requested?.termMonths ?? 0 }} cuotas mensuales por un valor aproximado de</p>
          <p class="cuota-valor">${{ resultados?.fija?.totals?.monthlyPaymentApprox ?? 0 | number:'1.0-0' }}</p>
        </div>

        <details class="detalle-tasas">
          <summary>Tasas y tarifas</summary>
          <div class="lista-tasas">
            <div class="item-tasa">
              <span>Tasa mes vencido</span>
              <span>{{ getPrimerRate(resultados?.fija?.requested?.annualRate) | number:'1.2-2' }}%</span>

            </div>
            <div class="item-tasa">
              <span>Seguro de vida</span>
              <span>${{ (resultados?.fija?.requested.sure ?? 0) | number:'1.0-0' }}</span>
            </div>
          </div>
          <a class="enlace-plan" (click)="verPlanPagos('fija')">Conocer el plan de pagos</a>
        </details>
        @if (inLogin == true) {
        <button class="boton-solicitar" (click)="guardarSimulacion('fija')" (click)="verPlanPagos('fija')"> Solicitar crédito </button>
        }@else{
        <button class="boton-solicitar" (click)="mostrarWelcome = true"> Solicitar crédito </button>
        }
      </div>

      <!-- TARJETA 2 -->
      <div class="tarjeta-credito">
        <div class="encabezado-tarjeta">
          <span class="titulo-tarjeta">Tasa variable - Cuota fija</span>
        </div>


        <div class="monto-credito">
          <p class="label">Por un crédito de:</p>
          <p class="valor"> ${{ resultados?.variableFija?.requested?.amount ?? 0 | number:'1.0-0' }} </p>

        </div>

        <div class="resumen-cuota">
          <p>Pagarás {{ resultados?.variableFija?.requested?.termMonths ?? 0 }} cuotas mensuales por un valor aproximado
            de:</p>
          <p class="cuota-valor">${{ resultados?.variableFija?.totals?.monthlyPaymentApprox ?? 0 | number:'1.0-0' }}</p>
        </div>

        <details class="detalle-tasas">
          <summary>Tasas y tarifas</summary>
          <div class="lista-tasas">
            <div class="item-tasa">
              <span>Tasa mes vencido</span>
              <span>{{ getPrimerRate(resultados?.variableFija?.requested?.annualRate) | number:'1.2-2' }}%</span>

            </div>
            <div class="item-tasa">
              <span>Seguro de vida</span>
              <span>${{ (resultados?.variableFija?.requested.sure ?? 0) | number:'1.0-0' }}</span>

            </div>
          </div>
          <a class="enlace-plan" (click)="verPlanPagos('variableFija')">Conocer el plan de pagos</a>
        </details>

        @if (inLogin == true) {
        <button class="boton-solicitar" (click)="guardarSimulacion('variableFija')" (click)="verPlanPagos('variableFija')"> Solicitar crédito </button>
        }@else{
        <button class="boton-solicitar" (click)="mostrarWelcome = true"> Solicitar crédito </button>
        }

      </div>

      <!-- TARJETA 3 -->
      <div class="tarjeta-credito">
        <div class="encabezado-tarjeta">
          <span class="titulo-tarjeta">Tasa variable - Cuota variable</span>
        </div>


        <div class="monto-credito">
          <p class="label">Por un crédito de:</p>
          <p class="valor"> ${{ resultados?.fullVariable?.requested?.amount ?? 0 | number:'1.0-0' }} </p>

        </div>

        <div class="resumen-cuota">
          <p>Pagarás {{ resultados?.fullVariable?.requested?.termMonths ?? 0 }} cuotas mensuales por un valor aproximado
            de</p>
          <p class="cuota-valor">${{ resultados?.fullVariable?.totals?.monthlyPaymentApprox ?? 0 | number:'1.0-0' }}</p>
        </div>

        <details class="detalle-tasas">
          <summary>Tasas y tarifas</summary>
          <div class="lista-tasas">
            <div class="item-tasa">
              <span>Tasa mes vencido</span>
              <span>{{ getPrimerRate(resultados?.fullVariable?.requested?.annualRate) | number:'1.2-2' }}%</span>

            </div>
            <div class="item-tasa">
              <span>Seguro de vida</span>
              <span>${{ (resultados?.fullVariable?.requested.sure ?? 0) | number:'1.0-0' }}</span>
            </div>
          </div>
          <a class="enlace-plan" (click)="verPlanPagos('fullVariable')">Conocer el plan de pagos</a>
        </details>

        @if (inLogin == true) {
        <button class="boton-solicitar" (click)="guardarSimulacion('fullVariable')" (click)="verPlanPagos('fullVariable')"> Solicitar crédito </button>
        }@else{
        <button class="boton-solicitar" (click)="mostrarWelcome = true"> Solicitar crédito </button>
        }


      </div>
    </div>
  </section>
  }

  @if (mostrarWelcome) {
  <div class="btn-prev-exit d-flex justify-content-between ">
    <div (click)="volverAOpciones()" class="prev">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <title>Atrás</title>
        <path d="M19 12H5" />
        <path d="M11 18l-6-6 6-6" />
      </svg>
      Atrás
    </div>

    <div routerLink="/home" class="exit">Salir
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" role="img" aria-label="Salir"
        fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <title>Salir</title>
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
        <path d="M16 17l5-5-5-5" />
        <path d="M21 12H9" />
      </svg>
    </div>
  </div>
  <section class="welcome-container">
    <div class="welcome-box">
      <h4>Te damos la bienvenida</h4>
      <h2>¿Ya tienes cuenta en CrediTest?</h2>

      <button routerLink="/login" class="btn-primary">Tengo cuenta</button>
      <button routerLink="/register" class="btn-secondary">Crear cuenta</button>
    </div>
  </section>
  }

  @if (mostrarPlanPagos) {
  <div class="btn-prev-exit d-flex justify-content-between ">
    <div (click)="volverAOpcionesDesdePlan()" class="prev">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <title>Atrás</title>
        <path d="M19 12H5" />
        <path d="M11 18l-6-6 6-6" />
      </svg>
      Atrás
    </div>

    @if(inLogin == false) {
    <div routerLink="/home" class="exit">Salir
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" role="img" aria-label="Salir"
        fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <title>Salir</title>
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
        <path d="M16 17l5-5-5-5" />
        <path d="M21 12H9" />
      </svg>
    </div>
    }

  </div>


  <section class="detalle-pagos-contenedor">
    <h3 class="titulo-detalle fw-semibold text-center">
      Plan de pagos para tu crédito de
      <span class="fw-bold text-primary">
        ${{ resultados?.fija?.requested?.amount ?? 0 | number:'1.0-0' }}
      </span>
      a pagar en
      <span class="fw-bold text-primary">
        {{ resultados?.fija?.requested?.termMonths ?? 0 }}
      </span> cuotas mensuales.
    </h3>
    <p class=" text-center my-4">Resultados aproximados y sujetos a estudio de crédito y políticas de la entidad.</p>


    <div class="layout-dos-columnas">

      <!-- COLUMNA IZQUIERDA -->
      <div class="grafico">
        @if (planActivo && planActivo.length > 0) {
        <canvas #chartCanvas></canvas>

        } @else {
        <p>No hay datos para mostrar el gráfico.</p>
        }
      </div>

      <!-- COLUMNA DERECHA -->
      <div class="contenido-derecha">

        <!-- TABS AÑOS -->
        <div class="tabs-anios">
          @for (anio of anios; let i = $index; track anio) {
          <button class="tab-anio" [class.activo]="i === anioSeleccionado" (click)="anioSeleccionado = i">
            Año {{ anio }}
          </button>
          }
        </div>

        <!-- LISTA DE MESES -->
        <div class="lista-meses">

          @if (schedulePorAnios.length > 0) {
          @for (item of schedulePorAnios[anioSeleccionado]; track item.period) {
          <div class="tarjeta-mes">

            <div class="tarjeta-mes-header">
              <h3 class="tarjeta-mes-titulo">Mes {{ item.period }}</h3>

              <div class="tarjeta-mes-cuota">
                Cuota mensual <strong>${{ item.payment | number:'1.0-0' }}</strong>
              </div>
            </div>

            <ul class="tarjeta-mes-detalles">
              <li>Abono intereses: ${{ item.interest | number:'1.0-0' }}</li>
              <li>Abono a capital: ${{ item.principal | number:'1.0-0' }}</li>
              <li>Seguro de vida: ${{ item.sure | number:'1.0-0' }}</li>
            </ul>

            <div class="tarjeta-mes-saldo">
              Saldo restante:
              <strong>${{ item.balance | number:'1.0-0' }}</strong>
            </div>

          </div>
          }
          } @else {
          <p>No existen datos disponibles para este año.</p>
          }

        </div>

      </div>

    </div>

  </section>
  }


  <!-- Modal -->
  <div class="modal-overlay" [class.show]="isModalOpen">
    <div class="modal-box">

      <!-- Loader -->
      @if (isLoading) {
      <div class="loader"></div>
      <p>Analizando solicitud...</p>
      }

      <!-- Resultado -->
      @if (!isLoading) {
      <h2 class="{{resultadoAnalisis?.approvalStatus}} mb-5">¡Crédito {{resultadoAnalisis?.approvalStatus}}!</h2>

      <div class="actions">
        @if (resultadoAnalisis?.approvalStatus == 'aprobado') {
        <button class="btn-accept" (click)="acceptLoan()" (click)="aceptadoPorUsuario('aprobado')">Aceptar préstamo</button>
        <button class="btn-reject" (click)="rejectLoan()" (click)="aceptadoPorUsuario('rechazado')">Rechazar</button>
        }@else {
          <button class="btn-reject" (click)="rejectLoan()">Finalizar</button>
        }
      </div>
      }

    </div>
  </div>
</div>
